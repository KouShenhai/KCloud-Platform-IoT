---
title: 组件【shardingsphere】
date: 2025-03-11 15:21:31
permalink: /pages/zj54/
---

小伙伴们，你们好，欢迎来到老寇云平台，这个组件【shardingsphere】是分库分表&读写分离，支持从nacos拉取配置

### 使用

[nacos-shardingsphere例子，请点击我](https://github.com/KouShenhai/KCloud-Platform-IoT/tree/master/laokou-sample/laokou-sample-shardingsphere)

<font color="red">注意：需要自己提前创建数据库和表</font>

<img src="/img/组件【shardingsphere】/img.png">

1.引入依赖
```xml
  <dependencies>
    <dependency>
      <groupId>org.laokou</groupId>
      <artifactId>laokou-common-shardingsphere</artifactId>
    </dependency>
  </dependencies>
```

2.配置分库分表&读写分离

<font color="red">注意：对shardingsphere数据库用户名/密码进行加密与解密</font>
```java
class ShardingSphereTest {

	@Test
	void testCrypto() throws Exception {
		// 私钥加密，公钥解密
		String str = "123456";
		String publicKey = "MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAJ4o6sn4WoPmbs7DR9mGQzuuUQM9erQTVPpwxIzB0ETYkyKffO097qXVRLA6KPmaV+/siWewR7vpfYYjWajw5KkCAwEAAQ==";
		String encryptStr = CryptoUtils.encrypt(str);
		String decryptStr = CryptoUtils.decrypt(publicKey, encryptStr);
		Assertions.assertEquals(str, decryptStr);
	}

}
```

application-shardingsphere.yaml【nacos配置】
```yaml
# 加密公钥
public-key: MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAJ4o6sn4WoPmbs7DR9mGQzuuUQM9erQTVPpwxIzB0ETYkyKffO097qXVRLA6KPmaV+/siWewR7vpfYYjWajw5KkCAwEAAQ==
dataSources:
  # 主表【数据库配置，请按照作者来，请不要瞎几把改！！！】
  master:
    dataSourceClassName: com.zaxxer.hikari.HikariDataSource
    driverClassName: org.postgresql.Driver
    jdbcUrl: jdbc:postgresql://postgresql:5432/kcloud_platform_test?tcpKeepAlive=true&reWriteBatchedInserts=true&stringtype=unspecified&ApplicationName=laokou-sample-shardingsphere&useSSL=false
    username: ENC(VZamSTMi224AH6RUtJGXNldiDp/XEL2ozRhBUu/o9ChodT4JEb9kE/j0EFhXKbjsfvLVacUW0AUzetA6OrNJug==)
    password: ENC(laIHkPM/z03tYjA95hES4+BhyjyhvrPjJynrC65oDyXnUTP0Tge1UxwERWFBbHoOOQZ2GzzUrRhEYJ3jFb89eQ==)
  # 从表【数据库配置，请按照作者来，请不要瞎几把改！！！】
  slave:
    dataSourceClassName: com.zaxxer.hikari.HikariDataSource
    driverClassName: org.postgresql.Driver
    jdbcUrl: jdbc:postgresql://postgresql:5432/kcloud_platform_test?tcpKeepAlive=true&reWriteBatchedInserts=true&stringtype=unspecified&ApplicationName=laokou-sample-shardingsphere&useSSL=false
    username: ENC(VZamSTMi224AH6RUtJGXNldiDp/XEL2ozRhBUu/o9ChodT4JEb9kE/j0EFhXKbjsfvLVacUW0AUzetA6OrNJug==)
    password: ENC(laIHkPM/z03tYjA95hES4+BhyjyhvrPjJynrC65oDyXnUTP0Tge1UxwERWFBbHoOOQZ2GzzUrRhEYJ3jFb89eQ==)
rules:
- !SHARDING
  tables:
    # 分表的表名
    boot_sys_user:
      # 分表规则，按月份分表
      actualDataNodes: master.boot_sys_user_20240$->{1..9},master.boot_sys_user_2024$->{10..12}
      # 分表策略
      tableStrategy:
        # 规格
        standard:
          # 按创建时间字段分表
          shardingColumn: create_date
          # 自定义分表算法名称
          shardingAlgorithmName: laokou_table_inline
      # 主键生成策略
      keyGenerateStrategy:
        # 主键字段名称
        column: id
        # 主键生成采用的算法名称
        keyGeneratorName: snowflake
  # 自定义分表算法
  shardingAlgorithms:
    # 自定义分表算法名称
    laokou_table_inline:
      # 时间范围分片算法
      type: INTERVAL
      props:
        # 分片键的时间戳格式
        datetime-pattern: "yyyy-MM-dd HH:mm:ss"
        # 真实表的后缀格式
        sharding-suffix-pattern: "yyyyMM"
        # 时间分片下界值
        datetime-lower: "2024-01-01 00:00:00"
        # 时间分片上界值
        datetime-upper: "2024-12-31 23:59:59"
        # 分片间隔
        datetime-interval-amount: 1
        # 按月分表
        datetime-interval-unit: "months"
  # 主键生成器
  keyGenerators:
    # 雪花算法配置
    snowflake:
      # 雪花算法
      type: SNOWFLAKE
      # 属性
      props:
        # 机器工作ID
        work-id: 123
- !READWRITE_SPLITTING
  # 数据源分组
  dataSourceGroups:
    # 读写分离配置
    laokou_readwrite_data_sources:
      # 主节点写入
      writeDataSourceName: master
      # 从节点读取
      readDataSourceNames:
        - slave
      # 自定义负载均衡算法名称
      loadBalancerName: laokou_load_balance_algorithm
  # 自定义负载均衡算法
  loadBalancers:
    # 自定义负载均衡算法名称
    laokou_load_balance_algorithm:
      # 轮询调度算法
      type: ROUND_ROBIN
# 属性配置
props:
  # 显示SQL语句
  sql-show: true
```

3.使用
```yaml
spring:
  datasource:
    dynamic:
      datasource:
        master:
		  # 拉取nacos的配置
          url: jdbc:shardingsphere:nacos:application-shardingsphere.yaml
		  # 这个配置请写死，请不要瞎几把改【基于spi发现】
		  # 这个配置请写死，请不要瞎几把改【基于spi发现】
		  # 这个配置请写死，请不要瞎几把改【基于spi发现】
          driver-class-name: org.laokou.common.shardingsphere.config.nacos.NacosShardingSphereDriver
  cloud:
	  # nacos的使用，请参考本教程组件【nacos】一节有详细介绍
	  nacos:
		  discovery:
			  server-addr: nacos:8848
			  username: nacos
			  password: nacos
			  namespace: public
			  cluster-name: laokou-cluster
			  group: DEFAULT_GROUP
		  config:
			  server-addr: nacos:8848
			  username: nacos
			  password: nacos
			  namespace: public
			  cluster-name: laokou-cluster
			  # https://github.com/alibaba/spring-cloud-alibaba/blob/2021.x/spring-cloud-alibaba-docs/src/main/asciidoc-zh/nacos-config.adoc
			  # 指定读取的文件格式
			  file-extension: yaml
			  group: DEFAULT_GROUP
			  refresh-enabled: true
```

4.启动nacos和laokou-sample-shardingsphere【略】

5.启动并访问 http://localhost:9033

### 扩展
众所周知，市面上的配置中心五花八门，如何适配各种配置中心？，跟随我来扩展吧！

在开始之前，我们先来看一下[ShardingSphereDriver](https://github.com/apache/shardingsphere/blob/master/jdbc/src/main/java/org/apache/shardingsphere/driver/ShardingSphereDriver.java) 了解整个加载流程

这个流程也很简单，其实就是将yaml文件的数据转换成以shardingsphere形式的数据源，因此，我们可以将公共部分进行抽象，只需要对接各个配置中心是如何拉取配置的。

我是老寇，我们下次再见
